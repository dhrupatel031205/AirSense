{% extends 'base.html' %}
{% load static %}

{% block title %}ML Predictions - AirSense{% endblock %}

{% block extra_css %}
<style>
.prediction-card {
    transition: all 0.3s ease;
}
.prediction-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
}
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-50 to-blue-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="mb-8">
            <h1 class="text-3xl font-bold theme-text">ML Predictions</h1>
            <p class="theme-muted mt-1">AI-powered air quality forecasting and analysis</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Real-time Predictions -->
            <div class="card prediction-card">
                <h2 class="text-xl font-semibold mb-4">Real-time Forecasting</h2>
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span>Current AQI</span>
                        <span class="font-bold text-2xl" id="current-aqi">{{ current_aqi|default:73 }}</span>
                    </div>
                    <div class="h-64">
                        <canvas id="forecast-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Anomaly Detection -->
            <div class="card prediction-card">
                <h2 class="text-xl font-semibold mb-4">Anomaly Detection</h2>
                <div id="anomaly-status" class="space-y-3">
                    <div class="flex items-center justify-between">
                        <span>Status</span>
                        <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm">Normal</span>
                    </div>
                    <div class="text-sm theme-muted">
                        No unusual patterns detected in the last 24 hours.
                    </div>
                </div>
            </div>

            <!-- Scenario Simulation -->
            <div class="card prediction-card">
                <h2 class="text-xl font-semibold mb-4">What-If Scenarios</h2>
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <button data-scenario="wildfire_nearby" class="btn-outline text-sm py-2">
                        <i class="fas fa-fire mr-1"></i>Wildfire
                    </button>
                    <button data-scenario="heavy_traffic" class="btn-outline text-sm py-2">
                        <i class="fas fa-car mr-1"></i>Traffic
                    </button>
                    <button data-scenario="strong_winds" class="btn-outline text-sm py-2">
                        <i class="fas fa-wind mr-1"></i>Winds
                    </button>
                    <button data-scenario="temperature_spike" class="btn-outline text-sm py-2">
                        <i class="fas fa-thermometer-full mr-1"></i>Heat
                    </button>
                </div>
                <div id="scenario-results" class="text-sm theme-muted">
                    Select a scenario to see predicted air quality impact.
                </div>
            </div>

            <!-- Health Recommendations -->
            <div class="card prediction-card">
                <h2 class="text-xl font-semibold mb-4">Health Assistant</h2>
                <div id="health-chat-container-full">
                    <!-- Health chat interface -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    initializeForecastChart();
    loadAnomalyStatus();
    initializeHealthChat();
});

function initializeForecastChart() {
    const ctx = document.getElementById('forecast-chart');
    if (!ctx) return;

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['Now', '3h', '6h', '9h', '12h', '15h', '18h', '21h', '24h'],
            datasets: [{
                label: 'Predicted AQI',
                data: [73, 68, 45, 52, 61, 78, 89, 125, 95],
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true, max: 200 }
            }
        }
    });
}

function loadAnomalyStatus() {
    fetch('/dashboard/api/ml/predictions/')
        .then(response => response.json())
        .then(data => {
            const statusDiv = document.getElementById('anomaly-status');
            if (data.anomaly_status && data.anomaly_status.is_anomaly) {
                statusDiv.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span>Status</span>
                        <span class="px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm">Anomaly</span>
                    </div>
                    <div class="text-sm text-red-600">
                        ${data.alert ? data.alert.message : 'Unusual pattern detected'}
                    </div>
                `;
            }
        })
        .catch(error => console.error('Failed to load anomaly status:', error));
}

function initializeHealthChat() {
    const container = document.getElementById('health-chat-container-full');
    container.innerHTML = `
        <div class="h-64 overflow-y-auto mb-3 p-3 bg-gray-50 rounded-lg" id="chat-messages">
            <div class="flex justify-start mb-2">
                <div class="bg-blue-100 text-blue-800 px-3 py-2 rounded-lg max-w-xs">
                    <i class="fas fa-robot mr-2"></i>
                    Hi! Ask me about air quality and health recommendations.
                </div>
            </div>
        </div>
        <div class="flex">
            <input type="text" id="chat-input" placeholder="Ask about air quality..." 
                   class="flex-1 px-3 py-2 border rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button onclick="sendMessage()" class="bg-blue-500 text-white px-4 py-2 rounded-r-lg hover:bg-blue-600">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    `;
}

function sendMessage() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    if (!message) return;

    addChatMessage(message, 'user');
    input.value = '';

    // Helper to get CSRF token from form or cookie
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken') || '';

    fetch('/dashboard/api/ml/chat/', {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({
            message: message,
            current_aqi: parseInt(document.getElementById('current-aqi').textContent)
        })
    })
    .then(response => response.json())
    .then(data => {
        addChatMessage(data.response, 'bot');
    })
    .catch(error => {
        addChatMessage('Sorry, I encountered an error. Please try again.', 'bot');
    });
}

// Attach scenario button handlers to call scenario_simulation API and display results
document.addEventListener('DOMContentLoaded', function() {
    const buttons = document.querySelectorAll('button[data-scenario]');
    if (!buttons) return;

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken') || '';

    buttons.forEach(btn => {
        btn.addEventListener('click', function() {
            const scenario = this.getAttribute('data-scenario');
            const resultsDiv = document.getElementById('scenario-results');
            if (!scenario) return;
            resultsDiv.textContent = 'Running simulation...';

            fetch('/dashboard/api/ml/scenarios/', {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({ scenario: scenario })
            }).then(resp => resp.json())
            .then(data => {
                if (data.error) {
                    resultsDiv.textContent = 'Simulation failed: ' + data.error;
                } else {
                    resultsDiv.innerHTML = '<pre class="text-xs">' + JSON.stringify(data, null, 2) + '</pre>';
                }
            }).catch(err => {
                resultsDiv.textContent = 'Unable to run simulation. Check server.';
                console.error('Scenario simulation error:', err);
            });
        });
    });
});

function addChatMessage(message, sender) {
    const container = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'} mb-2`;
    
    messageDiv.innerHTML = `
        <div class="max-w-xs px-3 py-2 rounded-lg ${
            sender === 'user' 
                ? 'bg-blue-500 text-white' 
                : 'bg-blue-100 text-blue-800'
        }">
            ${sender === 'bot' ? '<i class="fas fa-robot mr-2"></i>' : ''}
            ${message}
        </div>
    `;
    
    container.appendChild(messageDiv);
    container.scrollTop = container.scrollHeight;
}
</script>
{% endblock %}